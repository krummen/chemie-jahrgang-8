<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lernmodul: Die Geheimsprache der Chemiker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; color: #333; max-width: 800px; margin: 2rem auto;
            padding: 0 1rem; background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;
        }
        .container {
            background-color: #ffffff; padding: 2rem; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .step {
            display: none; border-top: 1px solid #ddd; padding-top: 1.5rem; margin-top: 1.5rem;
        }
        .info-block {
            background-color: #ecf0f1; border-left: 5px solid #3498db; padding: 15px;
            margin: 1rem 0; border-radius: 0 5px 5px 0;
        }
        .instruction { color: #c0392b; font-weight: bold; }
        .instruction-emoji { font-size: 1.2em; margin-right: 8px; }
        .question-container {
            margin-top: 1.5rem; padding: 15px; border: 1px solid #bdc3c7; border-radius: 5px;
        }
        .answer-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            border: 2px solid #7f8c8d; background-color: #ffffff; color: #34495e;
            font-size: 1em; text-align: left; border-radius: 5px; cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .answer-btn:hover:not(:disabled) { background-color: #ecf0f1; border-color: #3498db; }
        .answer-btn.correct { background-color: #dff9d8; border-color: #27ae60; color: #27ae60; font-weight: bold; }
        .answer-btn.incorrect { background-color: #f9d8d8; border-color: #c0392b; color: #c0392b; }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.8; }
        .nav-btn {
            display: inline-block; background-color: #3498db; color: #ffffff; padding: 12px 25px;
            border-radius: 5px; text-decoration: none; font-size: 1.1em; border: none; cursor: pointer;
            margin-top: 1.5rem; float: right; transition: background-color 0.3s, opacity 0.3s;
        }
        .nav-btn:hover:not(:disabled) { background-color: #2980b9; }
        .nav-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
        #start-section, #end-section, #heftansicht-section { text-align: center; }
        #end-section, #heftansicht-section { display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #ddd; }
        .heftansicht-content { text-align: left; padding: 1.5rem; background-color: #fdfdfd; border: 1px solid #eee; border-radius: 5px;}
        .heftansicht-content h3 { color: #3498db; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .heftansicht-content .skizzen-hinweis { font-style: italic; color: #7f8c8d; background-color: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .score { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin: 2rem 0; }
        figure { margin: 1.5rem 0; text-align: center; }
        figure img { max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; }
        .gallery img { width: 100px; height: 100px; object-fit: contain; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
        .gallery img:hover { transform: scale(1.1); }
        .lightbox { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
        .lightbox img { max-width: 80%; max-height: 80%; }
        .interactive-table, .vorsilben-table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; }
        .interactive-table td, .interactive-table th, .vorsilben-table td, .vorsilben-table th { border: 1px solid #ddd; padding: 8px; text-align: center; vertical-align: middle; }
        .interactive-table th, .vorsilben-table th { background-color: #f2f2f2; }
        .interactive-table input[type="text"], .interactive-table input[type="number"], .interactive-table select { width: 90%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
        .interactive-table .desc-container { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .interactive-table .desc-container input[type="number"] { width: 50px; flex-shrink: 0; }
        .interactive-table .desc-container select { width: 100px; flex-shrink: 0;}
        .correct-input { background-color: #dff9d8; border: 1px solid #27ae60; }
        .incorrect-input { background-color: #f9d8d8; border: 1px solid #c0392b; }
        .prefilled, .formatted-formula { color: #555; background-color: #f8f9fa; padding: 6px; display: block; text-align: center; font-size: 1.2em; min-height: 28px; cursor: pointer; }
        .drawing-placeholder { height: 80px; display: flex; align-items: center; justify-content: center; background-color: #fafafa; border: 2px dashed #ddd; }
        .drawing-placeholder button { font-size: 0.9em; padding: 8px 12px; }
        .svg-drawing { max-height: 80px; width: 100%; }
        .completion-message, .feedback-gif { display: none; margin-top: 1rem; padding: 1rem; border-radius: 5px; text-align: center; font-weight: bold; }
        .completion-message { background-color: #dff9d8; border: 1px solid #27ae60; }
    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute;">
        <defs>
            <pattern id="dots" patternUnits="userSpaceOnUse" width="6" height="6"><circle cx="3" cy="3" r="1" fill="black" /></pattern>
            <pattern id="stripes" patternUnits="userSpaceOnUse" width="6" height="6" patternTransform="rotate(45)"><rect width="3" height="6" fill="black"/></pattern>
            <pattern id="checks" patternUnits="userSpaceOnUse" width="8" height="8"><rect width="4" height="4" fill="black"/><rect x="4" y="4" width="4" height="4" fill="black"/></pattern>
        </defs>
    </svg>
    <div class="lightbox" id="lightbox"><img id="lightbox-img" src=""></div>

    <div class="container">
        <h1>Modul 7: Die Geheimsprache der Chemiker</h1>
        <div id="start-section"><button class="nav-btn" id="start-btn">Lektion starten</button></div>
        <div id="content-container">
            <!-- SCHRITT 1-4 -->
            <div class="step">
                <h2>Das Rätsel der "Schalkesäure"</h2>
                <p class="info-block">Chemie ist, wenn H₂SO₄ nichts mit Fußball zu tun hat...</p>
                <figure><img src="bilder/h2so4_intro.jpg" alt="Vergleich Schalke 04 Logo und Schwefelsäure Warnsymbol"></figure>
                <p class="info-block">Was bedeutet dieses merkwürdige Kürzel H₂SO₄? Um diese und andere 'Geheimformeln' der Chemiker zu entschlüsseln, müssen wir einen Schritt zurückgehen und uns anschauen, wie unsere Welt aufgebaut ist.</p>
                <button class="nav-btn">Weiter</button>
            </div>
            <div class="step">
                <h2>Die große Idee der Chemie</h2>
                <p class="info-block">Die wichtigste Aufgabe der Naturwissenschaften ist es, die unglaublich komplexe Welt um uns herum zu verstehen...</p>
                <figure><img src="bilder/stoffvielfalt.jpg" alt="Vielfalt der Stoffe"></figure>
                <div class="question-container">
                    <p><strong>Frage 1/4:</strong> Was ist die "große Idee" der Chemie?</p>
                    <button class="answer-btn" data-correct="false">A) Es gibt für jeden Stoff auf der Welt eine eigene, einzigartige Atomsorte.</button>
                    <button class="answer-btn" data-correct="false">B) Alle Stoffe bestehen aus den vier Grundelementen Feuer, Wasser, Erde und Luft.</button>
                    <button class="answer-btn" data-correct="true">C) Die riesige Vielfalt aller Stoffe entsteht durch die Kombination von nur ca. 100 verschiedenen Atomsorten.</button>
                </div>
                <button class="nav-btn" disabled>Weiter</button>
            </div>
            <div class="step">
                <h2>Es kommt auf die Kombination an</h2>
                <p class="info-block">Es ist also entscheidend, <strong>welche</strong> Atome man kombiniert und <strong>wie viele</strong> von jeder Sorte.</p>
                <figure><img src="bilder/h2o_vs_h2o2.jpg" alt="Vergleich von Wasser und Wasserstoffperoxid"></figure>
                <div class="question-container">
                    <p><strong>Frage 2/4:</strong> Was zeigt der Vergleich von Wasser (H₂O) und Wasserstoffperoxid (H₂O₂)?</p>
                    <button class="answer-btn" data-correct="false">A) Dass Stoffe mit Sauerstoff immer gefährlich sind.</button>
                    <button class="answer-btn" data-correct="true">B) Dass eine kleine Änderung im atomaren Aufbau (ein Sauerstoff-Atom mehr) die Eigenschaften eines Stoffes komplett verändern kann.</button>
                    <button class="answer-btn" data-correct="false">C) Dass man durch Hinzufügen von Atomen die Farbe eines Stoffes verändern kann.</button>
                </div>
                <button class="nav-btn" disabled>Weiter</button>
            </div>
            <div class="step">
                <h2>Die Abkürzung für Faule: Die Summenformel</h2>
                <p class="info-block">Man könnte diese Verbindungen jedes Mal als Modelle zeichnen. Da Chemiker aber schlau (und bequem) sind, haben sie eine schnelle Abkürzung erfunden: die <strong>Summenformel</strong>.</p>
                <figure><img src="bilder/co2_erklaerung.jpg" alt="Erklärung der Summenformel am Beispiel von CO2"></figure>
                <p class="instruction"><span class="instruction-emoji">✒️</span>Übernimm das Beispiel <code>CO₂</code> mit den Erklärungen in dein Heft.</p>
                <p class="info-block">Die Namen der Verbindungen enthalten oft griechische Zahlwörter, die die Anzahl der Atome angeben.</p>
                <table class="vorsilben-table">
                    <thead><tr><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th></tr></thead>
                    <tbody><tr><td>mon(o)</td><td>di</td><td>tri</td><td>tetr(a)</td><td>pent(a)</td></tr></tbody>
                </table>
                <p class="instruction"><span class="instruction-emoji">✒️</span>Übernimm diese Tabelle in dein Heft. Zeichne anschließend die folgenden Eselsbrücken in der richtigen Reihenfolge unter die Begriffe. Klicke auf die Bilder, um sie zu vergrößern.</p>
                <div class="gallery" id="mnemonics-gallery"></div>
                <p class="instruction" style="margin-top: 2rem;"><span class="instruction-emoji">✒️</span>Trage nun die folgende Überschrift in dein Heft ein: <strong>Die Sprache der Chemie - Summenformeln</strong>.</p>
                <button class="nav-btn">Weiter zur Arbeitsblatt-Kontrolle</button>
            </div>
            <div class="step">
                <h2>Überprüfung deines Arbeitsblattes</h2>
                <p class="info-block">Du hast nun das Arbeitsblatt 'Chemische Symbole und Molekülformeln' bearbeitet. Überprüfe jetzt deine handschriftlichen Einträge. Korrigiere die roten Felder so lange, bis alles grün ist.</p>
                <h3>Teil 1: Symbol-Tabelle</h3>
                <table class="interactive-table" id="symbol-table"></table>
                <button class="nav-btn" id="check-symbols" style="float: none;">Symbole überprüfen</button>
                <div class="feedback-gif" id="feedback-symbols-error"><div class="tenor-gif-embed" data-postid="16803721" data-share-method="host" data-aspect-ratio="1.05611" data-width="20%"></div></div>
                <div class="feedback-gif" id="feedback-symbols-success"><div class="tenor-gif-embed" data-postid="24047970" data-share-method="host" data-aspect-ratio="1" data-width="20%"></div></div>
                
                <h3 style="margin-top: 2rem;">Teil 2: Was ist hier dargestellt?</h3>
                <table class="interactive-table" id="molecule-table"></table>
                <button class="nav-btn" id="check-molecules" style="float: none;">Einträge überprüfen</button>
                <div class="feedback-gif" id="feedback-molecules-error"><div class="tenor-gif-embed" data-postid="16803721" data-share-method="host" data-aspect-ratio="1.05611" data-width="20%"></div></div>
                <div class="feedback-gif" id="feedback-molecules-success"><div class="tenor-gif-embed" data-postid="24047970" data-share-method="host" data-aspect-ratio="1" data-width="20%"></div></div>
                
                 <div class="question-container">
                    <p><strong>Frage 3/4:</strong> "Diphosphorpentoxid" enthält 2 Phosphor-Atome (P) und 5 Sauerstoff-Atome (O). Wie lautet die korrekte Summenformel?</p>
                    <button class="answer-btn" data-correct="false">A) P₅O₂</button>
                    <button class="answer-btn" data-correct="true">B) P₂O₅</button>
                    <button class="answer-btn" data-correct="false">C) 2P5O</button>
                </div>
                 <div class="question-container">
                    <p><strong>Frage 4/4:</strong> Wie lautet die korrekte chemische Formel für <strong>Schwefeltrioxid</strong>?</p>
                    <button class="answer-btn" data-correct="false">A) SO</button>
                    <button class="answer-btn" data-correct="false">B) SO₂</button>
                    <button class="answer-btn" data-correct="true">C) SO₃</button>
                </div>
                <div id="completion-message" class="completion-message" style="margin-top: 2rem;">Sehr gut! Alle Tabellen-Einträge sind korrekt.</div>
                <button class="nav-btn" id="finish-lesson-btn" disabled>Lektion abschließen</button>
            </div>
        </div>
        <div id="end-section"></div>
        <div id="heftansicht-section"></div>
    </div>
    <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-btn');
    const contentContainer = document.getElementById('content-container');
    const steps = Array.from(contentContainer.querySelectorAll('.step'));
    const endSectionContainer = document.getElementById('end-section');
    const heftSectionContainer = document.getElementById('heftansicht-section');
    let currentStepIndex = 0;
    let score = 0;

    function showNextStep(event) {
        if (event) event.target.style.display = 'none';
        currentStepIndex++;
        if (currentStepIndex < steps.length) {
            steps[currentStepIndex].style.display = 'block';
            steps[currentStepIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            showEndScreen();
        }
    }

    function showEndScreen() {
        const totalQuestions = contentContainer.querySelectorAll('.question-container').length;
        endSectionContainer.innerHTML = `
            <h2>Modul abgeschlossen!</h2>
            <p class="score">Du hast ${score} von ${totalQuestions} Fragen im ersten Versuch richtig beantwortet.</p>
            <button class="nav-btn" id="heft-btn">Heftansicht erstellen</button>
            <a href="index.html" class="nav-btn" style="float: left;">Zurück zur Übersicht</a>`;
        endSectionContainer.style.display = 'block';
        document.getElementById('heft-btn').addEventListener('click', showHeftansicht);
    }

    function showHeftansicht() {
        contentContainer.style.display = 'none';
        endSectionContainer.style.display = 'none';
        heftSectionContainer.innerHTML = `
            <h2>Hefteintrag: Die Sprache der Chemie - Summenformeln</h2>
            <div class="heftansicht-content">
                <h3>Die große Idee der Chemie</h3>
                <p>Die Vielfalt aller Stoffe entsteht durch die Kombination von nur ca. 100 verschiedenen Atomsorten.</p>
                <h3>Die Summenformel</h3>
                <p>Eine Summenformel ist eine Abkürzung, die qualitativ (Welche Atome?) und quantitativ (Wie viele Atome?) den Aufbau eines Stoffes beschreibt.</p>
                <div class="skizzen-hinweis">[Hier sollte dein übernommenes Beispiel für CO₂ sein.]</div>
                <div class="skizzen-hinweis">[Hier sollte deine übernommene Tabelle der Vorsilben mit den gezeichneten Eselsbrücken sein.]</div>
                <div class="skizzen-hinweis">[Hier sollte dein ausgefülltes und korrigiertes Arbeitsblatt 'Chemische Symbole und Molekülformeln' eingeklebt sein.]</div>
            </div>
            <button class="nav-btn" id="back-to-interactive-btn">Zurück</button>`;
        heftSectionContainer.style.display = 'block';
        document.getElementById('back-to-interactive-btn').addEventListener('click', () => {
            heftSectionContainer.style.display = 'none';
            contentContainer.style.display = 'block';
            endSectionContainer.style.display = 'block';
        });
        window.scrollTo(0, 0);
    }
    
    startBtn.addEventListener('click', () => {
        document.getElementById('start-section').style.display = 'none';
        steps[0].style.display = 'block';
    });
    
    steps.forEach((step, index) => {
        if (index >= 4) return;
        const nextButton = step.querySelector('.nav-btn');
        nextButton.addEventListener('click', showNextStep);
        const questionsInStep = step.querySelectorAll('.question-container');
        if (questionsInStep.length > 0) {
            nextButton.disabled = true;
            questionsInStep.forEach(qContainer => {
                let firstTry = true;
                const answerButtons = qContainer.querySelectorAll('.answer-btn');
                answerButtons.forEach(button => {
                    button.addEventListener('click', () => {
                         if (qContainer.classList.contains('answered')) return;
                         qContainer.classList.add('answered');
                         const isCorrect = button.getAttribute('data-correct') === 'true';
                         if(isCorrect) {
                            button.classList.add('correct');
                            if(firstTry) score++;
                         } else {
                            button.classList.add('incorrect');
                            const correctBtn = qContainer.querySelector('[data-correct="true"]');
                            if(correctBtn) correctBtn.classList.add('correct');
                         }
                         firstTry = false;
                         answerButtons.forEach(btn => btn.disabled = true);
                         const allAnswered = Array.from(step.querySelectorAll('.question-container')).every(q => q.classList.contains('answered'));
                         if(allAnswered) nextButton.disabled = false;
                    });
                });
            });
        }
    });

    const mnemonics = [
        { src: 'bilder/monolog.jpg', name: 'mono' }, { src: 'bilder/dialog.jpg', name: 'di' },
        { src: 'bilder/triangel.jpg', name: 'tri' }, { src: 'bilder/tetrapack.jpg', name: 'tetra' },
        { src: 'bilder/pentagramm.jpg', name: 'penta' }
    ];
    mnemonics.sort(() => Math.random() - 0.5);
    const gallery = document.getElementById('mnemonics-gallery');
    mnemonics.forEach(item => {
        const img = document.createElement('img');
        img.src = item.src;
        img.alt = item.name;
        img.onclick = () => {
            document.getElementById('lightbox').style.display = 'flex';
            document.getElementById('lightbox-img').src = item.src;
        };
        gallery.appendChild(img);
    });
    document.getElementById('lightbox').onclick = () => {
        document.getElementById('lightbox').style.display = 'none';
    };
    
    const atomFill = {
        'O': 'url(#dots)', 'H': 'white', 'C': 'black',
        'Cl': 'url(#stripes)', 'S': 'url(#checks)', 'N': 'grey'
    };
    function drawAtom(atomType, x, y, r = 12) { return `<circle cx="${x}" cy="${y}" r="${r}" fill="${atomFill[atomType]}" stroke="black" stroke-width="1.5" />`; }

    function drawMolecule(type) {
        let svgContent = ''; const viewBox = '0 0 200 60';
        switch(type) {
            case '2 CO': svgContent = drawAtom('O', 25, 30) + drawAtom('C', 45, 30) + drawAtom('O', 125, 30) + drawAtom('C', 145, 30); break;
            case '3 H₂O': svgContent = drawAtom('O', 25, 30) + drawAtom('H', 15, 18, 10) + drawAtom('H', 35, 18, 10) + drawAtom('O', 80, 30) + drawAtom('H', 70, 18, 10) + drawAtom('H', 90, 18, 10) + drawAtom('O', 135, 30) + drawAtom('H', 125, 18, 10) + drawAtom('H', 145, 18, 10); break;
            case 'CH₄': svgContent = drawAtom('C', 100, 30) + drawAtom('H', 100, 15, 10) + drawAtom('H', 100, 45, 10) + drawAtom('H', 85, 30, 10) + drawAtom('H', 115, 30, 10); break;
            case '4 O': svgContent = drawAtom('O', 20, 30) + drawAtom('O', 60, 30) + drawAtom('O', 100, 30) + drawAtom('O', 140, 30); break;
            case '2 O₂': svgContent = drawAtom('O', 30, 30) + drawAtom('O', 50, 30) + drawAtom('O', 110, 30) + drawAtom('O', 130, 30); break;
            case '4 N + O': svgContent = drawAtom('N', 20, 30) + drawAtom('N', 50, 30) + drawAtom('N', 80, 30) + drawAtom('N', 110, 30) + drawAtom('O', 150, 30); break;
            case 'Cl₂': svgContent = drawAtom('Cl', 90, 30) + drawAtom('Cl', 110, 30); break;
            case '2 SO₂': svgContent = drawAtom('S', 40, 30, 14) + drawAtom('O', 25, 18) + drawAtom('O', 55, 18) + drawAtom('S', 120, 30, 14) + drawAtom('O', 105, 18) + drawAtom('O', 135, 18); break;
        }
        return `<svg viewBox="${viewBox}" class="svg-drawing">${svgContent}</svg>`;
    }
    
    function formatFormula(text) { if (!text) return ''; return text.replace(/([A-Za-z])(\d+)/g, '$1<sub>$2</sub>').replace(/^(\d+)\s*/, '$1 '); }

    const symbolData = [
        { name: 'Sauerstoff', symbol: 'O', type: 'O' }, { name: 'Wasserstoff', symbol: 'H', type: 'H' },
        { name: 'Kohlenstoff', symbol: 'C', type: 'C' }, { name: 'Chlor', symbol: 'Cl', type: 'Cl' },
        { name: 'Schwefel', symbol: 'S', type: 'S' }, { name: 'Stickstoff', symbol: 'N', type: 'N' }
    ];
    
    const moleculeData = [
        { draw: '2 CO', formula: '2 CO', desc_num: '2', desc_type: 'Moleküle', desc_name: 'Kohlenmonoxid'},
        { draw: 'draw', type: '3 H₂O', formula: '3 H2O', desc_num: '3', desc_type: 'Moleküle', desc_name: 'Diwasserstoffmonoxid (besser bekannt als Wasser)'},
        { draw: 'CH₄', formula: 'CH4', desc_num: '1', desc_type: 'Molekül', desc_name: ['Methan', 'Kohlenstofftetrawasserstoff', 'Tetrawasserstoffkohlenstoff']},
        { draw: '4 O', formula: '4 O', desc_num: '4', desc_type: 'Atome', desc_name: 'Sauerstoff'},
        { draw: 'draw', type: '2 O₂', formula: '2 O2', desc_num: '2', desc_type: 'Moleküle', desc_name: 'Sauerstoff'},
        { draw: '4 N + O', formula: '4 N + O', desc: [{desc_num: '4', desc_type: 'Atome', desc_name: 'Stickstoff'}, {desc_num: '1', desc_type: 'Atom', desc_name: 'Sauerstoff'}] },
        { draw: 'Cl₂', formula: 'Cl2', desc_num: '1', desc_type: 'Molekül', desc_name: 'Chlor'},
        { draw: 'draw', type: '2 SO₂', formula: '2 SO2', desc_num: '2', desc_type: 'Moleküle', desc_name: 'Schwefeldioxid'}
    ];

    const symbolTable = document.getElementById('symbol-table');
    let symbolHtml = '<thead><tr><th>Element</th><th>chemisches Symbol</th><th>Darstellung</th></tr></thead><tbody>';
    symbolData.forEach(item => {
        symbolHtml += `<tr><td>${item.name}</td><td><input type="text" data-correct="${item.symbol}"></td><td><svg viewBox="-15 -15 30 30" height="30">${drawAtom(item.type, 0, 0)}</svg></td></tr>`;
    });
    symbolTable.innerHTML = symbolHtml + '</tbody>';
    
    const moleculeTable = document.getElementById('molecule-table');
    let moleculeHtml = '<thead><tr><th>Was ist hier dargestellt?</th><th>Summenformel</th><th>Beschreibung</th></tr></thead><tbody>';
    moleculeData.forEach((item, index) => {
        const rowData = item;
        if(index === 5) {
            let drawCell = `<td rowspan="2">${drawMolecule(rowData.draw)}</td>`;
            let formulaCell = `<td rowspan="2"><div class="formula-container"><input type="text" data-correct="${rowData.formula}" class="formula-input"><div class="formatted-formula" style="display:none;"></div></div></td>`;
            let descCell1 = `<td><div class="desc-container"><input type="number" data-correct="${rowData.desc[0].desc_num}"><select data-correct="${rowData.desc[0].desc_type}"><option>...</option><option>Atom</option><option>Atome</option><option>Molekül</option><option>Moleküle</option></select><input type="text" data-correct="${rowData.desc[0].desc_name}"></div></td>`;
            let descCell2 = `<td><div class="desc-container"><input type="number" data-correct="${rowData.desc[1].desc_num}"><select data-correct="${rowData.desc[1].desc_type}"><option>...</option><option>Atom</option><option>Atome</option><option>Molekül</option><option>Moleküle</option></select><input type="text" data-correct="${rowData.desc[1].desc_name}"></div></td>`;
            moleculeHtml += `<tr>${drawCell}${formulaCell}${descCell1}</tr><tr>${descCell2}</tr>`;
        } else {
            let drawCell = (rowData.draw === 'draw') ? `<td class="drawing-placeholder"><button class="nav-btn" data-draw-id="${index}">Zeichnung aufdecken</button></td>` : `<td>${drawMolecule(rowData.draw)}</td>`;
            let formulaCell = `<td><div class="formula-container"><input type="text" data-correct="${rowData.formula}" class="formula-input"><div class="formatted-formula" style="display:none;"></div></div></td>`;
            let descCell = `<td><div class="desc-container"><input type="number" data-correct="${rowData.desc_num}"><select data-correct="${rowData.desc_type}"><option>...</option><option>Atom</option><option>Atome</option><option>Molekül</option><option>Moleküle</option></select><input type="text" data-correct="${Array.isArray(rowData.desc_name) ? rowData.desc_name.join('|') : rowData.desc_name}"></div></td>`;
            if(index === 0) { formulaCell = `<td><div class="prefilled">${formatFormula(rowData.formula)}</div></td>`; descCell = `<td><div class="prefilled">${rowData.desc_num} ${rowData.desc_type} ${rowData.desc_name}</div></td>`; }
            else if(index === 1) { descCell = `<td><div class="prefilled">${rowData.desc_num} ${rowData.desc_type} ${rowData.desc_name}</div></td>`; }
            else if(index === 2) { formulaCell = `<td><div class="prefilled">${formatFormula(rowData.formula)}</div></td>`; }
            else if(index === 4) { formulaCell = `<td><div class="prefilled">${formatFormula(rowData.formula)}</div></td>`; }
            else if(index === 7) { descCell = `<td><div class="prefilled">${rowData.desc_num} ${rowData.desc_type} ${rowData.desc_name}</div></td>`; }
            moleculeHtml += `<tr>${drawCell}${formulaCell}${descCell}</tr>`;
        }
    });
    moleculeTable.innerHTML = moleculeHtml + '</tbody>';

    moleculeTable.querySelectorAll('.formula-input').forEach(input => {
        const parentDiv = input.parentElement;
        const formattedDisplay = parentDiv.querySelector('.formatted-formula');
        input.addEventListener('blur', () => { if (input.value.trim() !== '') { formattedDisplay.innerHTML = formatFormula(input.value); input.style.display = 'none'; formattedDisplay.style.display = 'block'; } });
        formattedDisplay.addEventListener('click', () => { if (!formattedDisplay.parentElement.classList.contains('correct-input')) { formattedDisplay.style.display = 'none'; input.style.display = 'block'; input.focus(); } });
    });
    
    function checkInputs(tableElement, errorFeedbackId, successFeedbackId) {
        let hasErrors = false;
        const inputs = tableElement.querySelectorAll('input:not([disabled]), select:not([disabled])');
        if (inputs.length === 0) { // If table is already complete, show success
             const successDiv = document.getElementById(successFeedbackId);
             successDiv.style.display = 'block';
             setTimeout(() => { successDiv.style.display = 'none'; }, 1500);
             return;
        }

        inputs.forEach(input => {
            const userValue = input.value.trim();
            const correctAnswers = input.dataset.correct.split('|');
            const isCorrect = correctAnswers.some(correct => {
                const isFormula = /[A-Z]/.test(correct);
                if (isFormula) { return userValue.replace(/\s/g, '') === correct.replace(/\s/g, ''); }
                else { return userValue.toLowerCase() === correct.toLowerCase(); }
            });
            const elementToStyle = input.classList.contains('formula-input') ? input.parentElement : input;
            elementToStyle.classList.remove('correct-input', 'incorrect-input');
            elementToStyle.classList.add(isCorrect ? 'correct-input' : 'incorrect-input');
            
            if (isCorrect) {
                input.disabled = true;
                if (input.classList.contains('formula-input')) { const display = input.nextElementSibling; display.innerHTML = formatFormula(correctAnswers[0]); input.style.display = 'none'; display.style.display = 'block'; }
                else if (input.parentElement.classList.contains('desc-container')) {
                    const container = input.parentElement;
                    const allParts = container.querySelectorAll('input, select');
                    if(Array.from(allParts).every(el => el.disabled)) {
                         const num = container.querySelector('input[type=number]').dataset.correct;
                         const type = container.querySelector('select').dataset.correct;
                         const name = container.querySelector('input[type=text]').dataset.correct.split('|')[0];
                         container.parentElement.innerHTML = `<div class="prefilled">${num} ${type} ${name}</div>`;
                    }
                }
            } else {
                hasErrors = true;
                if (input.classList.contains('formula-input')) { const display = input.nextElementSibling; display.style.display = 'none'; input.style.display = 'block'; }
            }
        });
        
        const feedbackDiv = hasErrors ? document.getElementById(errorFeedbackId) : document.getElementById(successFeedbackId);
        feedbackDiv.style.display = 'block';
        setTimeout(() => { feedbackDiv.style.display = 'none'; }, 1500);
    }

    function checkOverallCompletion() {
        const allSymbolInputs = Array.from(symbolTable.querySelectorAll('input'));
        const allMoleculeInputs = Array.from(moleculeTable.querySelectorAll('input, select'));
        const allQuestions = Array.from(steps[4].querySelectorAll('.question-container'));
        const allTablesDone = allSymbolInputs.every(i => i.disabled) && allMoleculeInputs.every(i => i.disabled);
        const allQuestionsDone = allQuestions.every(q => q.classList.contains('answered'));
        if (allTablesDone && allQuestionsDone) {
             document.getElementById('finish-lesson-btn').disabled = false;
        }
    }

    document.getElementById('check-symbols').addEventListener('click', () => {
        checkInputs(symbolTable, 'feedback-symbols-error', 'feedback-symbols-success');
        checkOverallCompletion();
    });
    
    document.getElementById('check-molecules').addEventListener('click', () => {
        checkInputs(moleculeTable, 'feedback-molecules-error', 'feedback-molecules-success');
        checkOverallCompletion();
    });
    
    moleculeTable.querySelectorAll('[data-draw-id]').forEach(button => {
        button.addEventListener('click', () => {
            const id = parseInt(button.dataset.drawId);
            const parentCell = button.parentElement;
            parentCell.innerHTML = drawMolecule(moleculeData[id].type);
            parentCell.classList.remove('drawing-placeholder');
        });
    });
    
    const abStep = steps[4];
    const abQuestions = abStep.querySelectorAll('.question-container');
    abQuestions.forEach(qContainer => {
        let firstTry = true;
        const answerButtons = qContainer.querySelectorAll('.answer-btn');
        answerButtons.forEach(button => {
            button.addEventListener('click', () => {
                if (qContainer.classList.contains('answered')) return;
                qContainer.classList.add('answered');
                const isCorrect = button.getAttribute('data-correct') === 'true';
                if(isCorrect) {
                   button.classList.add('correct');
                   if(firstTry) score++;
                } else {
                   button.classList.add('incorrect');
                   const correctBtn = qContainer.querySelector('[data-correct="true"]');
                   if(correctBtn) correctBtn.classList.add('correct');
                }
                firstTry = false;
                answerButtons.forEach(btn => btn.disabled = true);
                checkOverallCompletion();
            });
        });
    });
    
    document.getElementById('finish-lesson-btn').addEventListener('click', showNextStep);
});
</script>
</body>
</html>